# Tentacula

Приложение Tentacula работает как терминирующий компонент. Когда клиенту нужно обратиться к удалённой системе, доступ к
которой напрямую невозможен или не рекомендуется, на разрыв между клиентом и сервером устанавливается Tentacula. По
HTTP-протоколу клиент передаёт данные необходимые для запроса (данные авторизации и атрибуты запроса), на заранее
опубликованную "Присоску". Присоска уже с терминирующего компонента обращается на конечный сервис (протокол между
Tentacula и сервером определяется в функции самой Присоски). После того как сервер даст ответ, терминирующий компонент
ретранслирует его клиенту.
Клиент и терминирующий компонент должны использовать сертификаты, подписанные единым корневым сертификатом.
Предназначен для работы в комплексе с NGINX или иным проксирующим приложением, способным передавать данные сертификата и
код сессии в Header.
Ключевой функционал:

1. suсkers (присоски) - эндпоинт использующий POST-протокол, с заранее описанными требованиями и функционалом, который
   будет исполнен с сервера Tentacula;
2. composition (сочленение) - механизм передачи клиентского запроса через несколько последовательно стоящих Tentacula,
   чтобы последняя в очереди Tentacula обратилась к серверу;
3. schedulers (планировщик) - механизм автозапуска заданий, которые необходимо исполнять с сервера Tentacula;

## Установка

Пакет Tentacula подготовлен для установки в оффлайн режиме. Описание корневых файлов:

- `app` - папка содержащие исходный код приложения, написанного на uvicorn + FastAPI;
- `config.cfg` - файл настройки приложения Tentacula;
- `composition_alias.json` - файл описывающий правила для механизма "Сочленений";
- `.gitignore` - список файлов исключённых для передачи в Git;
- `environment.yml` - файл описывающий зависимости, которые будут добавлены в Conda-Pack;
- `build.sh` - скрипт генерации Conda-Pack для приложения, если необходимо создать или обновить среду;
- `tentacula.tar.gz` - готовое окружение созданное через Conda-Pack;
- `LICENSE` - описание лицензии приложения;
- `NOTICE` - список использованных зависимостей и описание их лицензий;
- `README.md` - информационный файл текущего текста.

### Установка зависимостей

Перед настойкой приложения требуется установка следующих зависимостей:

```
apt-get update && apt-get install -y \
bash \
bzip2 \
tar \
ca-certificates \
gcc \
libldap2-dev \
libsasl2-dev \
libssl-dev
```

### Подготовка рабочей области

Рабочая область приложения структурируется следующим образом (на примере относительно пути `/app/tentacula`):

- Папка приложения `app` располагается в корне рабочей области;
- В корне рабочей области обязательно должны быть конфигурационные файлы `config.cfg` и `composition_alias.json`;
- Сертификаты, папка с сочленениями и папка с планировщиком могут быть переопределены в любое место через `config.cfg`;

### Подготовка среды Conda

Для работы через среду конда, на UNIX-системах необходимо корректно развернуть Conda-Pack. Папка с распакованным
Conda-Pack'ом является рабочей средой и далее её нужно будет указать в параметрах конфигурирования.
Подготовка среды (на примере относительно пути `/app/tentacula`, таким образом рабочей средой будет
`/app/tentacula/conda_env`):

```
mkdir /app/tentacula/conda_env
tar -xzf tentacula.tar.gz -C /app/tentacula/conda_env
rm tentacula.tar.gz
```

### Настройка переменных окружения и запуск службы

Переменные окружения необходимо для работы (обратите внимание на область среды):

```
ENV PATH="/app/tentacula/conda_env/bin:$PATH"
ENV PYTHONDONTWRITEBYTECODE=1
ENV PYTHONUNBUFFERED=1
```

Строка запуска приложения как ASGI web-сервера (запускается из области приложения `/app/tentacula`):
`/app/tentacula/conda_env/bin/conda-unpack && uvicorn app.main:app --host 0.0.0.0 --port 8000`

## Настройка среды

Переменные среды читаются либо из окружения, либо из config.cfg
Приоритет чтения:

1. Переменные окружения;
2. Конфигурационный файл `config.cfg`.

Переменные окружения генерируются по формуле: `TENTACULA__<РАЗДЕЛ>__<ПЕРЕМЕННАЯ>`

Следующие атрибуты, принимают путь файлу, в котором будет описано значение:

- `app` -> `DB_ASYNC_URL`;
- `app` -> `DB_SECRET_KEY`.