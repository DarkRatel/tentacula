# Инструкция создания пользовательских присосок

Перед использованием пользовательских присосок, необходимо включить поддержку параметром `SUCKERS_ENABLED` и указать
папку чтения параметром `SUCKERS_FOLDER`.

## Структура

Каждая новая присоска должна быть описана в отдельном файле ".py".
Файл присосок состоит из четырёх частей:

- Минимальный набор подключенных библиотек;
- BaseModel описывающий ожидаемые значения в теле POST;
- Пользовательская функция, исполняющаяся на сервере щупальцы;
- Системная функция создающая присоску типа POST.

## Пример присоски

```
# Минимальные зависимости
from pydantic import BaseModel  # Функция для объявления структуры ожидаемых значений
from app.moduls.post_base import create_post  # Функция создания эндпоинта типа POST
from app.sites.suckers import router_sucker  # API для ветки щупалец
from app.systems.logging import logger  # Функция логирования


# Класс основанный на BaseModel, описывающий ожидаемые значения в запросе
class SpecData(BaseModel):
    # Например, ключи типа int
    terms_1: int
    terms_2: int


# Функция, которая будет исполнена на сервере
def addition(terms_1: int, terms_2: int):
    # Для фиксации данных в логах требуется использовать "logger"
    logger.info("Hello world!")

    # Использование переменных, тип которых, по факту, был определён ещё в BaseModel
    # Если на эндпоинт не будут переданы данные описанные в BaseModel, функция не будет исполнена

    # Если функция не заканчивается "return", ответ будет равен "None"
    return terms_1 + terms_2


# Функция создающая эндпоинт на основе имени эндпоинта, функции и ожидаемых значений
create_post(endpoint="addition", base_model=SpecData, func=addition, router=router_sucker)
```

## Общая информация

- Ответ от эндпоинта в формате JSON, со следующими базовыми значениями:
    - `username` - Строка с именем пользователя отправившего запрос (subject из сертификата);
    - `successfully` - Булевое значение со статусом исполнения функции (если было зафиксировано исключение, будет
      возвращено False);
    - `answer` - Ответ функции:
        - Если ответ (`return`) объявлен, возвращается ответ;
        - Если ответ не объявлен, возвращается `None`;
        - Если было исключение, возвращается текст исключения;
- Ответ функции конвертируется в формат JSON;

## Функция конвертации данных

В случае, если эндпоинт возвращает данные типа datetime, они будут возращенные в формате ISO, поэтому при получении
ответа требуется произвести конвертацию.
Функция конвертации ISO в datetime:

```
def datetime_parser(dct):
    for k, v in dct.items():
        if isinstance(v, str):
            try:
                dct[k] = datetime.fromisoformat(v)
            except ValueError:
                pass
    return dct
```

Конвертация JSON в формат данных Python: `response.json(object_hook=datetime_parser)`